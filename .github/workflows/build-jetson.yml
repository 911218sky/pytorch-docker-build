name: Build Jetson PyTorch Docker Images

on:
  workflow_dispatch:
    inputs:
      versions:
        description: "Version matrix JSON"
        required: true
        default: '[{"l4t":"r36.2.0","jetpack":"6.0","torch":"2.7.1","python":"3.11"}]'
        type: string
      cuda_arch_list:
        description: "CUDA architectures (5.3=Nano, 6.2=TX2, 7.2=Xavier, 8.7=Orin)"
        required: false
        default: "5.3;6.2;7.2;8.7"
        type: string

env:
  DOCKERHUB_IMAGE: sky1218/pytorch-jetson
  GHCR_IMAGE: ghcr.io/${{ github.repository_owner }}/pytorch-jetson

jobs:
  build:
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 360 # 6 hours max
    permissions:
      contents: write # For uploading releases
      packages: write
    strategy:
      fail-fast: false
      matrix:
        version: ${{ fromJson(inputs.versions) }}

    steps:
      - name: Free disk space
        run: |
          echo "Freeing disk space..."
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /opt/hostedtoolcache/go
          sudo rm -rf /opt/hostedtoolcache/node
          sudo docker image prune --all --force
          df -h

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate tag
        id: tag
        run: |
          L4T_VERSION="${{ matrix.version.l4t }}"
          JETPACK_VERSION="${{ matrix.version.jetpack }}"
          TORCH_VERSION="${{ matrix.version.torch }}"
          PYTHON_VERSION="${{ matrix.version.python }}"

          TAG="${TORCH_VERSION}-jp${JETPACK_VERSION}-py${PYTHON_VERSION}"
          RELEASE_TAG="jetson-wheels-v${TORCH_VERSION}"

          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "release_tag=${RELEASE_TAG}" >> $GITHUB_OUTPUT
          echo "torch_version=${TORCH_VERSION}" >> $GITHUB_OUTPUT
          echo "python_version=${PYTHON_VERSION}" >> $GITHUB_OUTPUT

          echo "========================================"
          echo "Building Jetson image: $TAG"
          echo "========================================"
          echo "  Base: nvcr.io/nvidia/l4t-base:${L4T_VERSION}"
          echo "  L4T: $L4T_VERSION"
          echo "  JetPack: $JETPACK_VERSION"
          echo "  PyTorch: $TORCH_VERSION"
          echo "  Python: $PYTHON_VERSION"
          echo "  Wheel Release Tag: $RELEASE_TAG"

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.jetson.template
          platforms: linux/arm64
          push: true
          tags: |
            ${{ env.DOCKERHUB_IMAGE }}:${{ steps.tag.outputs.tag }}
            ${{ env.GHCR_IMAGE }}:${{ steps.tag.outputs.tag }}
          build-args: |
            L4T_VERSION=${{ matrix.version.l4t }}
            TORCH_VERSION=${{ matrix.version.torch }}
            PYTHON_VERSION=${{ matrix.version.python }}
            MAX_JOBS=2
            TORCH_CUDA_ARCH_LIST=${{ inputs.cuda_arch_list }}
            GITHUB_OWNER=${{ github.repository_owner }}
            GITHUB_REPO=${{ github.event.repository.name }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          outputs: type=docker,dest=/tmp/image.tar

      - name: Extract wheels from image
        run: |
          docker load -i /tmp/image.tar
          IMAGE_ID=$(docker images -q | head -1)
          mkdir -p wheels
          docker run --rm -v $(pwd)/wheels:/output $IMAGE_ID sh -c "cp /wheels/*.whl /output/ 2>/dev/null || echo 'No wheels found (may have used cached wheels)'"
          ls -la wheels/ || echo "No wheels extracted"

      - name: Compress wheels (split if > 2GB)
        if: hashFiles('wheels/*.whl') != ''
        run: |
          cd wheels
          TOTAL_SIZE=$(du -sb . | cut -f1)
          echo "Total wheels size: $TOTAL_SIZE bytes"

          # 2GB = 2147483648 bytes
          MAX_SIZE=2147483648

          if [ "$TOTAL_SIZE" -gt "$MAX_SIZE" ]; then
            echo "Size exceeds 2GB, creating split archive..."
            tar -cvf - *.whl | split -b 1900M - pytorch-jetson-wheels-py${{ matrix.version.python }}.tar.part
            ls -la pytorch-jetson-wheels-py${{ matrix.version.python }}.tar.part*
          else
            echo "Size under 2GB, creating single archive..."
            tar -czvf pytorch-jetson-wheels-py${{ matrix.version.python }}.tar.gz *.whl
            ls -la pytorch-jetson-wheels-py${{ matrix.version.python }}.tar.gz
          fi

      - name: Upload wheels to GitHub Release
        if: hashFiles('wheels/*.whl') != ''
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.release_tag }}
          name: "Jetson Wheels - PyTorch ${{ steps.tag.outputs.torch_version }}"
          body: |
            Pre-built PyTorch wheels for NVIDIA Jetson (ARM64)

            - PyTorch: ${{ steps.tag.outputs.torch_version }}
            - Python: ${{ steps.tag.outputs.python_version }}
            - Platform: linux/arm64 (Jetson)
            - CUDA Arch: ${{ inputs.cuda_arch_list }}

            Install with:
            ```bash
            pip install <wheel_url>
            ```
          files: |
            wheels/*.whl
            wheels/pytorch-jetson-wheels-py${{ matrix.version.python }}.tar.gz
            wheels/pytorch-jetson-wheels-py${{ matrix.version.python }}.tar.part*
          fail_on_unmatched_files: false
          generate_release_notes: false
          make_latest: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Push final image
        run: |
          docker load -i /tmp/image.tar
          docker push ${{ env.DOCKERHUB_IMAGE }}:${{ steps.tag.outputs.tag }}
          docker push ${{ env.GHCR_IMAGE }}:${{ steps.tag.outputs.tag }}
